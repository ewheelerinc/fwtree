#!/bin/bash

echo 'Name: fwtree'
echo 'Summary: Tree-driven firewall'
echo "Version: $VERSION"
echo "Release: $PKGRELEASE"
echo "BuildArch: $ARCH"
echo 'Group: Application'
echo 'License: Restricted'
echo 'Prefix: /'
echo 'BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)'
echo 'Requires: ipset'
echo 'Conflicts: firewalld'
echo 'AutoReqProv: no'
echo ''
echo '%description'
echo ''
echo '%build'
echo "cp /usr/src/fwtree-git/$TARBALL %{_builddir}/$TARBALL"
echo ''
echo '%install'
echo 'mkdir -p $RPM_BUILD_ROOT/'
echo "mv $TARBALL"' $RPM_BUILD_ROOT/'"$TARBALL"
echo 'cd $RPM_BUILD_ROOT/'
echo 'tar -xf $RPM_BUILD_ROOT/'"$TARBALL"
echo 'rm $RPM_BUILD_ROOT/'"$TARBALL"
echo ''
echo '%clean'
echo 'rm -fr $RPM_BUILD_ROOT'
echo ''
echo '%post'
echo 'test -e /etc/iptables.d/COMMENT && exit'
echo ''
echo 'echo "Warning: SSH is the only service allowed by default."'
echo ''
echo 'ln -s /usr/share/fwtree/rules/COMMENT /etc/iptables.d/'
echo 'ln -s /usr/share/fwtree/rules/nat/_GLOBAL /etc/iptables.d/nat/'
echo 'ln -s /usr/share/fwtree/rules/filter/_GLOBAL /etc/iptables.d/filter/'
echo 'ln -s /usr/share/fwtree/rules/mangle/_GLOBAL /etc/iptables.d/mangle/'
echo ''
echo 'ln -s /usr/share/fwtree/rules/filter/DROPLOG/01-drop-and-log /etc/iptables.d/filter/DROPLOG/'
echo 'ln -s /usr/share/fwtree/rules/filter/OUTPUT_DROP_ALLOW/01-allow /etc/iptables.d/filter/OUTPUT_DROP_ALLOW/'
echo ''
echo 'ln -s /etc/iptables.d/filter/_GLOBAL/03-VALIDATE_TCP /etc/iptables.d/filter/INPUT/'
echo 'ln -s /etc/iptables.d/filter/_GLOBAL/03-VALIDATE_TCP /etc/iptables.d/filter/OUTPUT/'
echo 'ln -s /etc/iptables.d/filter/_GLOBAL/03-VALIDATE_TCP /etc/iptables.d/filter/FORWARD/'
echo ''
echo 'ln -s /etc/iptables.d/filter/_GLOBAL/05-established /etc/iptables.d/filter/INPUT/'
echo 'ln -s /etc/iptables.d/filter/_GLOBAL/05-established /etc/iptables.d/filter/OUTPUT/'
echo 'ln -s /etc/iptables.d/filter/_GLOBAL/05-established /etc/iptables.d/filter/FORWARD/'
echo ''
echo 'ln -s /etc/iptables.d/filter/_GLOBAL/08-lo-input-allow /etc/iptables.d/filter/INPUT/'
echo ''
echo 'ln -s /etc/iptables.d/filter/_GLOBAL/22-tcp-allow-ssh-throttled /etc/iptables.d/filter/INPUT/'
echo ''
echo 'ln -s /etc/iptables.d/filter/_GLOBAL/98-tcp-allow-fin-rst /etc/iptables.d/filter/INPUT/'
echo 'ln -s /etc/iptables.d/filter/_GLOBAL/98-tcp-allow-fin-rst /etc/iptables.d/filter/OUTPUT/'
echo 'ln -s /etc/iptables.d/filter/_GLOBAL/98-tcp-allow-fin-rst /etc/iptables.d/filter/FORWARD/'
echo ''
echo 'ln -s /etc/iptables.d/mangle/_GLOBAL/10-tos-default /etc/iptables.d/mangle/PREROUTING'
echo 'ln -s /etc/iptables.d/mangle/_GLOBAL/10-tos-default /etc/iptables.d/mangle/POSTROUTING'
echo 'ln -s /etc/iptables.d/mangle/_GLOBAL/10-tos-default /etc/iptables.d/mangle/OUTPUT'
echo 'ln -s /etc/iptables.d/mangle/_GLOBAL/10-tos-default /etc/iptables.d/mangle/FORWARD'
echo ''
echo '%files'
echo '%defattr (-, root, root)'
echo '/usr/sbin/fwtree'
echo '/usr/sbin/fwtree-parser'
echo '/usr/sbin/fwtree-update-blacklists'
echo '/usr/sbin/ipset-helper'
echo '/etc/iptables.d'
echo '/etc/cron.d/fwtree'
echo '/etc/ipset.d/noblacklist-ewheelerinc'
echo '/etc/rsyslog.d/20-fwtree.conf'
echo '/usr/share/fwtree'
if [ "$DIST" = 'el7' ]; then
echo '/usr/lib/systemd/system/fwtree.service'
fi
