#!/bin/bash

echo 'Name: fwtree'
echo 'Summary: Tree-driven firewall'
echo "Version: $VERSION"
echo "Release: $PKGRELEASE"
echo "BuildArch: $ARCH"
echo 'Group: Application'
echo 'License: Restricted'
echo 'Prefix: /'
echo 'BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n)'
if [ "$DIST" = 'el7' ]; then
echo 'BuildRequires: systemd-units'
fi
echo 'Requires: python'
echo 'Requires: ipset'
echo 'Requires: aggregate'
echo 'Requires: bind-utils'
echo 'Requires: epel-release'
echo 'AutoReqProv: no'
echo ''
echo '%description'
echo ''
echo '%build'
echo "cp /usr/src/fwtree-git/$TARBALL %{_builddir}/$TARBALL"
echo ''
echo '%install'
echo 'mkdir -p $RPM_BUILD_ROOT/'
echo "mv $TARBALL"' $RPM_BUILD_ROOT/'"$TARBALL"
echo 'cd $RPM_BUILD_ROOT/'
echo 'tar -xf $RPM_BUILD_ROOT/'"$TARBALL"
echo 'rm $RPM_BUILD_ROOT/'"$TARBALL"
echo ''
echo '%clean'
echo 'rm -fr $RPM_BUILD_ROOT'
echo ''
echo '%post'
if [ "$DIST" = 'el7' ]; then
echo 'systemctl daemon-reload'
fi
# Skip the post install if /etc/fwtree.d is populated
echo '[ "$(ls -A /etc/fwtree.d/)" ] && exit'
# Convert from iptables.d if it exists
echo '[ -d /etc/iptables.d ] && /usr/share/fwtree/iptablesd-convert && exit'
echo ''
echo 'echo'
echo 'echo "NOTICE: SSH (22/tcp) is the only inbound service enabled by default."'
echo 'echo'
echo ''
echo 'mkdir -p /etc/fwtree.d/{filter,nat,mangle}/{INPUT,OUTPUT}'
echo 'mkdir -p /etc/fwtree.d/{filter,mangle}/FORWARD'
echo 'mkdir -p /etc/fwtree.d/{nat,mangle}/{PRE,POST}ROUTING'
echo 'mkdir -p /etc/fwtree.d/filter/{BLACKLIST_CHECK,FORWARD_DROP,VALIDATE_TCP_DROP,VALIDATE_TCP,DROPLOG,INPUT_DROP,OVERLIMIT_DROP,OUTPUT_LOG_ALLOW,OUTPUT_DROP,THROTTLED_DROP,FWTREE_APPLIED,FROM_IPSEC}'
echo ''
echo 'ln -s /usr/share/fwtree/rules/nat/_GLOBAL /etc/fwtree.d/nat/'
echo 'ln -s /usr/share/fwtree/rules/filter/_GLOBAL /etc/fwtree.d/filter/'
echo 'ln -s /usr/share/fwtree/rules/mangle/_GLOBAL /etc/fwtree.d/mangle/'
echo ''
echo 'ln -s /usr/share/fwtree/rules/nat/_BEGIN /etc/fwtree.d/nat/'
echo 'ln -s /usr/share/fwtree/rules/filter/FWTREE_APPLIED/01-applied.rule /etc/fwtree.d/filter/FWTREE_APPLIED/'
echo 'ln -s /usr/share/fwtree/rules/filter/BLACKLIST_CHECK/99-blacklist-check.rule /etc/fwtree.d/filter/BLACKLIST_CHECK/'
echo 'ln -s /usr/share/fwtree/rules/filter/BLACKLIST_CHECK/01-noblacklist-check.rule /etc/fwtree.d/filter/BLACKLIST_CHECK/'
echo 'ln -s /usr/share/fwtree/rules/filter/FORWARD_DROP/01-drop.rule /etc/fwtree.d/filter/FORWARD_DROP/'
echo 'ln -s /usr/share/fwtree/rules/filter/VALIDATE_TCP_DROP/01-drop.rule /etc/fwtree.d/filter/VALIDATE_TCP_DROP/'
echo 'ln -s /usr/share/fwtree/rules/filter/INPUT/90-udp-allow-dhcp.rule /etc/fwtree.d/filter/INPUT/'
echo 'ln -s /usr/share/fwtree/rules/filter/INPUT/07-icmp-allow.rule /etc/fwtree.d/filter/INPUT/'
echo 'ln -s /usr/share/fwtree/rules/filter/INPUT/09-validate-network.rule /etc/fwtree.d/filter/INPUT/'
echo 'ln -s /usr/share/fwtree/rules/filter/INPUT/zz99-INPUT_DROP.rule /etc/fwtree.d/filter/INPUT/'
echo 'ln -s /usr/share/fwtree/rules/filter/INPUT/09-BLACKLIST_CHECK.rule /etc/fwtree.d/filter/INPUT/'
echo 'ln -s /usr/share/fwtree/rules/filter/_BEGIN /etc/fwtree.d/filter/'
echo 'ln -s /usr/share/fwtree/rules/filter/VALIDATE_TCP/01-validate-tcp.rule /etc/fwtree.d/filter/VALIDATE_TCP/'
echo 'ln -s /usr/share/fwtree/rules/filter/DROPLOG/01-drop-and-log.rule /etc/fwtree.d/filter/DROPLOG/'
echo 'ln -s /usr/share/fwtree/rules/filter/OUTPUT/07-icmp-allow.rule /etc/fwtree.d/filter/OUTPUT/'
echo 'ln -s /usr/share/fwtree/rules/filter/OUTPUT/zz99-OUTPUT_DROP.rule /etc/fwtree.d/filter/OUTPUT/'
echo 'ln -s /usr/share/fwtree/rules/filter/OUTPUT/yy99-OUTPUT_LOG_ALLOW.rule /etc/fwtree.d/filter/OUTPUT/'
echo 'ln -s /usr/share/fwtree/rules/filter/INPUT_DROP/01-drop.rule /etc/fwtree.d/filter/INPUT_DROP/'
echo 'ln -s /usr/share/fwtree/rules/filter/FORWARD/07-icmp-allow.rule /etc/fwtree.d/filter/FORWARD/'
echo 'ln -s /usr/share/fwtree/rules/filter/FORWARD/50-FROM_IPSEC.rule /etc/fwtree.d/filter/FORWARD/'
echo 'ln -s /usr/share/fwtree/rules/filter/FORWARD/90-loopback.rule /etc/fwtree.d/filter/FORWARD/'
echo 'ln -s /usr/share/fwtree/rules/filter/FORWARD/zz99-FORWARD_DROP.rule /etc/fwtree.d/filter/FORWARD/'
echo 'ln -s /usr/share/fwtree/rules/filter/OVERLIMIT_DROP/01-drop.rule /etc/fwtree.d/filter/OVERLIMIT_DROP/'
echo 'ln -s /usr/share/fwtree/rules/filter/OUTPUT_LOG_ALLOW/01-allow.rule /etc/fwtree.d/filter/OUTPUT_LOG_ALLOW/'
echo 'ln -s /usr/share/fwtree/rules/filter/OUTPUT_DROP/01-drop.rule /etc/fwtree.d/filter/OUTPUT_DROP/'
echo 'ln -s /usr/share/fwtree/rules/filter/THROTTLED_DROP/01-drop.rule /etc/fwtree.d/filter/THROTTLED_DROP/'
echo 'ln -s /usr/share/fwtree/rules/mangle/_BEGIN /etc/fwtree.d/mangle/'
echo 'ln -s /usr/share/fwtree/rules/mangle/PREROUTING/50-tag-ipsec.rule /etc/fwtree.d/mangle/PREROUTING/'
echo 'ln -s /usr/share/fwtree/rules/COMMENT /etc/fwtree.d/'
echo ''
echo 'ln -s /etc/fwtree.d/filter/_GLOBAL/03-VALIDATE_TCP.rule /etc/fwtree.d/filter/INPUT/'
echo 'ln -s /etc/fwtree.d/filter/_GLOBAL/03-VALIDATE_TCP.rule /etc/fwtree.d/filter/OUTPUT/'
echo 'ln -s /etc/fwtree.d/filter/_GLOBAL/03-VALIDATE_TCP.rule /etc/fwtree.d/filter/FORWARD/'
echo ''
echo 'ln -s /etc/fwtree.d/filter/_GLOBAL/05-established.rule /etc/fwtree.d/filter/INPUT/'
echo 'ln -s /etc/fwtree.d/filter/_GLOBAL/05-established.rule /etc/fwtree.d/filter/OUTPUT/'
echo 'ln -s /etc/fwtree.d/filter/_GLOBAL/05-established.rule /etc/fwtree.d/filter/FORWARD/'
echo ''
echo 'ln -s /etc/fwtree.d/filter/_GLOBAL/08-lo-input-allow.rule /etc/fwtree.d/filter/INPUT/'
echo ''
echo 'ln -s /etc/fwtree.d/filter/_GLOBAL/98-tcp-allow-fin-rst.rule /etc/fwtree.d/filter/INPUT/'
echo 'ln -s /etc/fwtree.d/filter/_GLOBAL/98-tcp-allow-fin-rst.rule /etc/fwtree.d/filter/OUTPUT/'
echo 'ln -s /etc/fwtree.d/filter/_GLOBAL/98-tcp-allow-fin-rst.rule /etc/fwtree.d/filter/FORWARD/'
echo ''
echo 'ln -s /etc/fwtree.d/mangle/_GLOBAL/10-tos-default.rule /etc/fwtree.d/mangle/PREROUTING'
echo 'ln -s /etc/fwtree.d/mangle/_GLOBAL/10-tos-default.rule /etc/fwtree.d/mangle/POSTROUTING'
echo 'ln -s /etc/fwtree.d/mangle/_GLOBAL/10-tos-default.rule /etc/fwtree.d/mangle/OUTPUT'
echo 'ln -s /etc/fwtree.d/mangle/_GLOBAL/10-tos-default.rule /etc/fwtree.d/mangle/FORWARD'
echo ''
echo 'cp /etc/fwtree.d/filter/_GLOBAL/22-tcp-allow-ssh-throttled.rule /etc/fwtree.d/filter/INPUT/'
echo 'chmod 600 /etc/fwtree.d/filter/INPUT/22-tcp-allow-ssh-throttled.rule'
echo ''
echo 'echo Run fwtree-update-blacklists to update blacklists'
echo 'echo'
echo ''
echo '%files'
echo '%defattr (-, root, root)'
echo '/usr/sbin/fwtree'
echo '/usr/sbin/fwtree-parser'
echo '/usr/sbin/fwtree-update-blacklists'
echo '/usr/sbin/ipset-helper'
echo '/etc/fwtree.d'
echo '/etc/cron.d/fwtree'
echo '/etc/ipset.d'
echo '/etc/rsyslog.d/20-fwtree.conf'
echo '/etc/logrotate.d/fwtree'
echo '/usr/share/fwtree'
if [ "$DIST" = 'el7' ]; then
echo '%{_unitdir}/fwtree.service'
else
echo '/etc/init.d/fwtree'
fi
